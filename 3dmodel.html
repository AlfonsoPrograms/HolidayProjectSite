<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our 3D Model</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/GLTFLoader.js"
            }
        }
        </script>
    <link rel="apple-touch-icon" sizes="180x180" href="./Favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./Favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./Favicons/favicon-16x16.png">
    <link rel="manifest" href="./Favicons/site.webmanifest">
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

    /* Basic Reset & Styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: sans-serif;
        /* Ensure the body allows the canvas to fill the screen if needed, 
           though the header styling might overlap it visually */
    }

    /* Header and Navbar Layout */
    .main-header {
        background-color: #333;
        color: white;
        padding: 10px 0;
        position: fixed;
        /* Makes the navbar stay at the top */
        width: 100%;
        top: 0;
        z-index: 1000;
        font-family: 'Inter', sans-serif;
        font-weight: 900;
    }

    .navbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .logo {
        color: white;
        text-decoration: none;
        font-size: 1.5rem;
        font-weight: bold;
        transition: all 0.3s ease-in-out;
    }

    .logo:hover {
        color: #4CAF50;
        /* Change color on hover */
    }

    .nav-links {
        list-style: none;
        display: flex;
    }

    .nav-links li {
        margin-left: 20px;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
    }

    .nav-link {
        color: white;
        text-decoration: none;
        padding: 5px 0;
        position: relative;
        transition: color 0.3s ease-in-out;
    }

    /* Smooth Hover Animation: Underline Effect */
    .nav-link::after {
        content: '';
        position: absolute;
        width: 0;
        height: 2px;
        display: block;
        margin-top: 5px;
        right: 0;
        background: #4CAF50;
        transition: width 0.3s ease-in-out, right 0.3s ease-in-out;
    }

    .nav-link:hover {
        color: #4CAF50;
    }

    .nav-link:hover::after {
        width: 100%;
        right: auto;
        left: 0;
    }

    /* Overlay button styles */
    #viewerOverlay {
        font-family: Inter, Arial, sans-serif;
    }

    #viewerOverlay .overlay-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 12px;
        border-radius: 8px;
        color: #111;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        max-width: 520px;
    }

    #viewerOverlay .overlay-actions {
        margin-top: 8px;
        display: flex;
        gap: 8px;
    }

    #viewerOverlay .overlay-btn {
        background: #0b63ff;
        color: #fff;
        border: none;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: transform 180ms ease, box-shadow 180ms ease, opacity 120ms ease;
    }

    #viewerOverlay .overlay-btn.secondary {
        background: #e6eefc;
        color: #071022;
    }

    #viewerOverlay .overlay-btn:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 30px rgba(11, 22, 60, 0.14);
        opacity: 0.98;
    }

    #viewerOverlay code {
        background: #f4f6fb;
        padding: 2px 6px;
        border-radius: 4px
    }

    .return-home {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 1400;
        background: #0b63ff;
        color: #fff;
        padding: 10px 12px;
        border-radius: 10px;
        text-decoration: none;
        box-shadow: 0 12px 30px rgba(11, 22, 60, 0.12);
        transition: transform .18s ease
    }

    .return-home:hover {
        transform: translateY(-6px)
    }

    .return-help {
        position: fixed;
        right: 18px;
        bottom: 64px;
        z-index: 1400;
        background: rgba(255, 255, 255, 0.9);
        color: #071022;
        padding: 8px 10px;
        border-radius: 8px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
        font-size: 13px
    }
</style>

<body>
    <header class="main-header">
        <nav class="navbar-container">
            <a href="./index.html" class="logo">Project</a>
            <ul class="nav-links">
                <li><a href="./index.html" class="nav-link">Home</a></li>
                <li><a href="./3dmodel.html" class="nav-link">Model</a></li>
                <li><a href="./pitch.html" class="nav-link">Pitch</a></li>
            </ul>
        </nav>
    </header>
    <main id="viewer" aria-label="3D viewer"></main>

    <!-- Loader / messages overlay (top-left) and center spinner -->
    <div id="viewerOverlay" aria-hidden="true"
        style="position:fixed;top:80px;left:20px;z-index:1200;pointer-events:none"></div>
    <div id="viewerSpinner" aria-hidden="true"
        style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1100;display:none;pointer-events:none">
        <div
            style="width:84px;height:84px;border-radius:12px;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.12)">
            <svg width="48" height="48" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#0b63ff" stroke-width="5" stroke-linecap="round"
                    stroke-dasharray="31.4 31.4">
                    <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s"
                        repeatCount="indefinite" />
                </circle>
            </svg>
        </div>
    </div>

    <script type="module">
        // Clean, single entry script: dynamic import with retry, progress spinner, UMD fallback
        const overlay = document.getElementById('viewerOverlay');
        const spinner = document.getElementById('viewerSpinner');

        function setOverlay(html) { overlay.innerHTML = html; overlay.style.pointerEvents = 'auto'; }
        function clearOverlay() { overlay.innerHTML = ''; overlay.style.pointerEvents = 'none'; }
        function showSpinner() { spinner.style.display = 'block' }
        function hideSpinner() { spinner.style.display = 'none' }

        // Delegated click handler for overlay buttons (robust against dynamic HTML)
        overlay.addEventListener('click', (ev) => {
            const btn = ev.target.closest('button');
            if (!btn) return;
            const id = btn.id;
            if (id === 'retryBtn') { clearOverlay(); showSpinner(); bootstrap(); }
            else if (id === 'tryUmd') { setOverlay('<div class="overlay-card">Loading UMD scripts...</div>'); injectUmdScripts(); }
            else if (id === 'serveBtn') { setOverlay('<div class="overlay-card">Run a local server from the folder and open <code>http://localhost:8000/</code><pre style="background:#fff;padding:8px;border-radius:6px;margin-top:8px">python -m http.server 8000</pre></div>'); }
            else if (id === 'retryLoad') { if (typeof window._retryLoad === 'function') window._retryLoad(); }
            else if (id === 'returnHome') { window.location.href = './index.html'; }
        });

        async function bootstrap() {
            clearOverlay(); showSpinner();
            try {
                const THREE = await import('three');
                const { GLTFLoader } = await import('three/examples/jsm/loaders/GLTFLoader.js');
                const { OrbitControls } = await import('three/examples/jsm/controls/OrbitControls.js');
                hideSpinner(); runThreeApp(THREE, GLTFLoader, OrbitControls);
            } catch (err) {
                hideSpinner(); console.error('Module import failed', err);
                setOverlay('<div class="overlay-card">\n  <strong style="color:#900">Failed to load Three.js modules from CDN.</strong>\n  <div style="margin-top:8px;">Possible causes: offline, firewall blocking cdn.jsdelivr.net, or browser blocking modules when opened as file.</div>\n  <div class="overlay-actions" style="margin-top:10px">\n    <button id="retryBtn" class="overlay-btn">Retry</button>\n    <button id="tryUmd" class="overlay-btn secondary">Try UMD fallback</button>\n    <button id="serveBtn" class="overlay-btn secondary">Run local server</button>\n  </div>\n</div>');
                // delegated overlay click handler will handle buttons (see listener above)
            }
        }

        function injectUmdScripts() {
            // inject non-module UMD builds and then initialize via initUMD
            const s1 = document.createElement('script'); s1.src = 'https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js';
            const s2 = document.createElement('script'); s2.src = 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js';
            const s3 = document.createElement('script'); s3.src = 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js';
            s3.onload = () => { // wait until last script likely loaded
                try { initUMD(); clearOverlay(); } catch (e) { console.error('UMD init failed', e); setOverlay('<div style="background:#fff6;padding:12px;border-radius:8px;color:#900">UMD fallback failed. See console.</div>'); }
            };
            s1.onerror = s2.onerror = s3.onerror = () => { setOverlay('<div style="background:#fff6;padding:12px;border-radius:8px;color:#900">Failed to load UMD scripts from CDN.</div>'); };
            document.head.appendChild(s1); document.head.appendChild(s2); document.head.appendChild(s3);
        }

        function runThreeApp(THREE, GLTFLoader, OrbitControls) {
            // check WebGL
            const canvasTest = document.createElement('canvas'); if (!window.WebGLRenderingContext || !(canvasTest.getContext('webgl') || canvasTest.getContext('experimental-webgl'))) { setOverlay('<div style="background:#fff6;padding:12px;border-radius:8px;color:#800">WebGL not supported in this browser.</div>'); return; }
            showSpinner();
            const headerHeight = document.querySelector('.main-header')?.offsetHeight || 60;
            const container = document.getElementById('viewer');
            container.style.position = 'absolute'; container.style.top = headerHeight + 'px'; container.style.left = '0'; container.style.right = '0'; container.style.bottom = '0';

            const scene = new THREE.Scene();
            scene.background = createGradientSky(THREE);

            const camera = new THREE.PerspectiveCamera(60, window.innerWidth / (window.innerHeight - headerHeight), 0.01, 1000);
            camera.position.set(2, 1.5, 4);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio || 1); renderer.setSize(window.innerWidth, window.innerHeight - headerHeight); renderer.domElement.style.display = 'block';
            container.appendChild(renderer.domElement);

            const hemi = new THREE.HemisphereLight(0xbde0ff, 0x444444, 1.2); scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5, 10, 7.5); scene.add(dir);

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0xf2f4f7, metalness: 0, roughness: 1 }));
            ground.rotation.x = -Math.PI / 2; ground.position.y = -0.01; scene.add(ground);

            const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.08; controls.target.set(0, 0.8, 0);

            const loader = new GLTFLoader();
            // expose retry function for delegated handler
            window._retryLoad = null;
            setOverlay('<div id="loadBox" style="background:rgba(255,255,255,0.95); padding:10px 12px; border-radius:8px; color:#111">Loading model... <span id="progressPct"></span></div>');
            showSpinner();
            // check that the model file is reachable before invoking GLTFLoader
            fetch('./Project.glb', { method: 'HEAD' }).then((resp) => {
                if (!resp.ok) throw new Error('Model not found: ' + resp.status);
                // start loader
                loader.load('./Project.glb', (gltf) => {
                    const model = gltf.scene; model.position.set(0, 0, 0); scene.add(model);
                    try { const box = new THREE.Box3().setFromObject(model); const size = box.getSize(new THREE.Vector3()).length(); const center = box.getCenter(new THREE.Vector3()); controls.maxDistance = size * 10; camera.near = Math.max(0.01, size / 100); camera.far = size * 100; camera.updateProjectionMatrix(); controls.target.copy(center); camera.position.copy(center).add(new THREE.Vector3(size * 0.7, size * 0.3, size * 1.0)); controls.update(); } catch (e) { console.warn('bounds error', e) }
                    clearOverlay(); hideSpinner();
                }, (xhr) => { const pctEl = document.getElementById('progressPct'); if (pctEl && xhr.total) pctEl.textContent = Math.round(xhr.loaded / xhr.total * 100) + '%'; }, (err) => {
                    console.error('Model load error', err);
                    hideSpinner();
                    // prepare a retry function the delegated handler can call
                    window._retryLoad = function () {
                        clearOverlay(); showSpinner();
                        loader.load('./Project.glb', () => { clearOverlay(); hideSpinner(); }, (xhr) => { const pctEl = document.getElementById('progressPct'); if (pctEl && xhr.total) pctEl.textContent = Math.round(xhr.loaded / xhr.total * 100) + '%'; }, (e) => { console.error(e); setOverlay('<div class="overlay-card" style="color:#900">Still failed. See console.</div>'); hideSpinner(); });
                    };
                    // fallback placeholder (SVG data URI) plus return home button
                    const placeholderSvg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360"><rect width="100%" height="100%" fill="#f3f7ff"/><text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" fill="#334155" font-family="Inter, Arial" font-size="20">Model unavailable</text><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="#667085" font-family="Inter, Arial" font-size="14">Please run a local server or check test.glb</text></svg>');
                    setOverlay('<div class="overlay-card" style="color:#900">Failed to load model. Check console and verify <code>test.glb</code> is present.<div style="margin-top:10px"><img src="data:image/svg+xml;utf8,' + placeholderSvg + '" alt="placeholder" style="max-width:320px;border-radius:8px;display:block;margin-bottom:10px"></div><div class="overlay-actions"><button id="retryLoad" class="overlay-btn">Retry Load</button><button id="returnHome" class="overlay-btn secondary">Return Home</button></div></div>');
                });
            }).catch((e) => {
                console.error('Model fetch failed', e);
                hideSpinner();
                const placeholderSvg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360"><rect width="100%" height="100%" fill="#f3f7ff"/><text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" fill="#334155" font-family="Inter, Arial" font-size="20">Model not accessible</text><text x="50%" y="60%" dominant-baseline="middle" text-anchor="middle" fill="#667085" font-family="Inter, Arial" font-size="14">Try running: python -m http.server 8000</text></svg>');
                setOverlay('<div class="overlay-card" style="color:#900">Model file could not be reached.<div style="margin-top:10px"><img src="data:image/svg+xml;utf8,' + placeholderSvg + '" alt="placeholder" style="max-width:320px;border-radius:8px;display:block;margin-bottom:10px"></div><div class="overlay-actions"><button id="serveBtn" class="overlay-btn secondary">Run local server</button><button id="returnHome" class="overlay-btn secondary">Return Home</button></div></div>');
            });

            function onWindowResize() { const h = document.querySelector('.main-header')?.offsetHeight || 60; camera.aspect = window.innerWidth / (window.innerHeight - h); camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight - h); }
            window.addEventListener('resize', onWindowResize);
            (function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); })();
        }

        function createGradientSky(THREE, width = 1024, height = 512) { const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); const grad = ctx.createLinearGradient(0, 0, 0, height); grad.addColorStop(0, '#bde0ff'); grad.addColorStop(0.6, '#e6f7ff'); grad.addColorStop(1, '#ffffff'); ctx.fillStyle = grad; ctx.fillRect(0, 0, width, height); return new THREE.CanvasTexture(canvas); }

        // UMD initializer (for injected non-module builds)
        function initUMD() {
            if (typeof THREE === 'undefined' || typeof THREE.GLTFLoader === 'undefined') { throw new Error('UMD Three/GLTFLoader not available'); }
            // use global THREE, THREE.GLTFLoader and THREE.OrbitControls (attached to THREE namespace in UMD builds)
            runThreeApp(THREE, THREE.GLTFLoader, THREE.OrbitControls);
        }

        // start
        window.addEventListener('load', () => { bootstrap(); });
    </script>
    <div class="return-help">When finished viewing, click "Return Home" to return to the main menu.</div>
    <a class="return-home" href="./index.html">Return Home</a>
</body>

</html>